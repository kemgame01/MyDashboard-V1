rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function getRole(uid) {
      return exists(/databases/$(database)/documents/users/$(uid))
        ? get(/databases/$(database)/documents/users/$(uid)).data.role
        : '';
    }

    function isRole(role) {
      return request.auth != null && getRole(request.auth.uid) == role;
    }
    
    function isRootAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isRootAdmin == true;
    }
    
    // --- RULES FOR COLLECTIONS ---

    // USERS: Users can read/update their own data. Admins can view/update other user profiles.
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || isRole('admin') || isRootAdmin();
    }
    
    // --- NEW RULE FOR ADMINS TO QUERY ALL CUSTOMERS ---
    // This is the required rule for the admin dashboard feature to work.
    // It allows admins to perform the `collectionGroup` query.
    match /{path=**}/customers/{customerId} {
      allow list: if isRole('admin') || isRootAdmin();
    }

    // CUSTOMERS: Regular users can manage their own customers. Admins have full access.
    match /users/{userId}/customers/{customerId} {
      // A regular user can get/write THEIR OWN customers and must limit list queries.
      allow get, write: if request.auth.uid == userId;
      allow list: if request.auth.uid == userId && request.query.limit <= 100;

      // An admin can get, list, or write to ANY customer document.
      allow get, list, write: if isRole('admin') || isRootAdmin();
    }

    // INVENTORY: Owner and specific roles can read. Only Admin/Manager can write.
    match /users/{userId}/inventory/{itemId} {
      allow read: if request.auth.uid == userId || isRole('admin') || isRole('manager');
      allow write: if request.auth.uid == userId && (isRole('admin') || isRole('manager'));
    }
    
    // INVENTORY HISTORY: Owner and specific roles can access.
    match /users/{userId}/inventoryHistory/{logId} {
       allow read, create: if request.auth.uid == userId || isRole('admin') || isRole('manager');
    }

    // TASKS: Private to the owner.
    match /users/{userId}/tasks/{taskId} {
      allow read, write: if request.auth.uid == userId;
    }

    // BRANDS, CATEGORIES, TRACKING COMPANIES: Authenticated users can read.
    match /brands/{brandId} {
      allow read: if request.auth != null;
      allow write: if isRootAdmin();
    }
    match /categories/{categoryId} {
      allow read: if request.auth != null;
      allow write: if isRootAdmin();
    }
    match /trackingCompanies/{companyId} {
      allow read: if request.auth != null;
    }
    
    // SALES: Users create their own. Specific roles can read all sales.
    match /sales/{saleId} {
      allow read: if request.auth.uid == resource.data.userId;
      allow list, get: if isRole('admin') || isRole('manager') || isRole('sales');
      allow create: if request.auth.uid == request.resource.data.userId;
    }

    // AUDIT LOGS: Only Admins/Root can access.
    match /auditLogs/{logId} {
        allow read, create: if isRole('admin') || isRootAdmin();
    }
  }
}